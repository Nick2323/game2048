<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>2048 Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #0A1628;
      color: #e0e0e0;
      font-family: "Helvetica Neue", Arial, sans-serif;
      font-size: 15px;
    }

    /* LOGIN */
    .login-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .login-box {
      background: #0D3B66;
      border-radius: 10px;
      padding: 40px;
      width: 360px;
    }
    .login-box h2 { color: #4DD0E1; margin-bottom: 24px; font-size: 22px; }
    .login-box input {
      width: 100%; padding: 12px; margin-bottom: 14px;
      border: none; border-radius: 6px;
      background: #0A1628; color: #fff; font-size: 15px;
    }
    .login-box button {
      width: 100%; padding: 12px; border: none; border-radius: 6px;
      background: #00ACC1; color: #fff; font-size: 15px; cursor: pointer;
    }
    .login-box button:hover { background: #26C6DA; }
    .login-error { color: #f44; margin-top: 10px; text-align: center; font-size: 14px; }

    /* LAYOUT */
    .app { display: none; }
    .sidebar {
      position: fixed; top: 0; left: 0;
      width: 220px; height: 100vh;
      background: #0D3B66;
      padding: 24px 0;
    }
    .sidebar h1 { color: #4DD0E1; font-size: 18px; padding: 0 20px 20px; border-bottom: 1px solid #0A1628; }
    .sidebar nav a {
      display: block; padding: 12px 20px;
      color: #aaa; text-decoration: none; cursor: pointer;
      transition: all 0.2s;
    }
    .sidebar nav a:hover, .sidebar nav a.active { background: #0A1628; color: #4DD0E1; }
    .sidebar .admin-user { padding: 20px; color: #666; font-size: 13px; position: absolute; bottom: 0; width: 100%; }
    .sidebar .admin-user span { color: #4DD0E1; }
    .sidebar .logout-btn {
      display: block; margin-top: 8px; padding: 8px 0;
      background: none; border: 1px solid #f44; border-radius: 4px;
      color: #f44; cursor: pointer; width: 100%; font-size: 13px;
    }

    .main { margin-left: 220px; padding: 30px; }

    /* STATS CARDS */
    .stats-grid {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 16px; margin-bottom: 30px;
    }
    .stat-card {
      background: #0D3B66; border-radius: 8px; padding: 20px; text-align: center;
    }
    .stat-card .value { font-size: 32px; font-weight: bold; color: #4DD0E1; }
    .stat-card .label { font-size: 13px; color: #888; margin-top: 4px; }

    /* SECTIONS */
    .section { display: none; }
    .section.active { display: block; }
    .section h2 { color: #4DD0E1; margin-bottom: 20px; font-size: 20px; }

    /* TABLE */
    table { width: 100%; border-collapse: collapse; }
    th { background: #0D3B66; padding: 12px; text-align: left; color: #4DD0E1; font-size: 13px; }
    td { padding: 12px; border-bottom: 1px solid #0D3B66; font-size: 14px; }
    tr:hover td { background: rgba(77,208,225,0.05); }

    .badge {
      display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 12px;
    }
    .badge-admin { background: #00ACC1; color: #fff; }
    .badge-user  { background: #1a3a5a; color: #aaa; }
    .badge-won   { background: #2e7d32; color: #fff; }
    .badge-lost  { background: #4a1a1a; color: #aaa; }

    .btn-del {
      padding: 5px 12px; border: none; border-radius: 4px;
      background: #c62828; color: #fff; cursor: pointer; font-size: 13px;
    }
    .btn-del:hover { background: #f44; }
    .btn-toggle {
      padding: 5px 12px; border: none; border-radius: 4px;
      background: #00838F; color: #fff; cursor: pointer; font-size: 13px; margin-right: 6px;
    }
    .btn-toggle:hover { background: #00ACC1; }

    .empty { color: #666; text-align: center; padding: 40px; }

    .btn-edit {
      padding: 5px 12px; border: none; border-radius: 4px;
      background: #1976D2; color: #fff; cursor: pointer; font-size: 13px; margin-right: 6px;
    }
    .btn-edit:hover { background: #2196F3; }

    /* MODAL */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 1000;
    }
    .modal.show { display: flex; }
    .modal-box {
      background: #0D3B66; border-radius: 10px; padding: 30px; width: 400px;
    }
    .modal-box h3 { color: #4DD0E1; margin-bottom: 20px; }
    .modal-box label { display: block; color: #888; font-size: 13px; margin-bottom: 6px; }
    .modal-box input {
      width: 100%; padding: 12px; margin-bottom: 16px;
      border: none; border-radius: 6px;
      background: #0A1628; color: #fff; font-size: 15px;
    }
    .modal-buttons { display: flex; gap: 10px; margin-top: 10px; }
    .modal-buttons button {
      flex: 1; padding: 12px; border: none; border-radius: 6px;
      font-size: 14px; cursor: pointer;
    }
    .btn-save { background: #00ACC1; color: #fff; }
    .btn-save:hover { background: #26C6DA; }
    .btn-cancel { background: #455A64; color: #fff; }
    .btn-cancel:hover { background: #607D8B; }
    .modal-error { color: #f44; font-size: 13px; margin-top: 10px; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-wrap" id="loginWrap">
  <div class="login-box">
    <h2>Admin Panel</h2>
    <input type="text" id="loginUser" placeholder="Username" />
    <input type="password" id="loginPass" placeholder="Password" />
    <button onclick="doLogin()">Login</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app">
  <div class="sidebar">
    <h1>2048 Admin</h1>
    <nav>
      <a class="active" onclick="showSection('dashboard')">Dashboard</a>
      <a onclick="showSection('users')">Users</a>
      <a onclick="showSection('results')">Game Results</a>
    </nav>
    <div class="admin-user">
      Logged in as <span id="adminName"></span>
      <button class="logout-btn" onclick="doLogout()">Logout</button>
    </div>
  </div>

  <div class="main">

    <!-- DASHBOARD -->
    <div class="section active" id="sec-dashboard">
      <h2>Dashboard</h2>
      <div class="stats-grid">
        <div class="stat-card"><div class="value" id="st-users">—</div><div class="label">Total Users</div></div>
        <div class="stat-card"><div class="value" id="st-games">—</div><div class="label">Total Games</div></div>
        <div class="stat-card"><div class="value" id="st-top">—</div><div class="label">Top Score</div></div>
        <div class="stat-card"><div class="value" id="st-today">—</div><div class="label">Games Today</div></div>
      </div>
    </div>

    <!-- USERS -->
    <div class="section" id="sec-users">
      <h2>Users</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Username</th><th>Email</th>
            <th>Role</th><th>Games</th><th>Best Score</th>
            <th>Registered</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="users-body"><tr><td colspan="8" class="empty">Loading…</td></tr></tbody>
      </table>
    </div>

    <!-- RESULTS -->
    <div class="section" id="sec-results">
      <h2>Game Results</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>User</th><th>Score</th>
            <th>Best Tile</th><th>Moves</th><th>Result</th>
            <th>Date</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="results-body"><tr><td colspan="8" class="empty">Loading…</td></tr></tbody>
      </table>
    </div>

  </div>
</div>

<!-- EDIT USER MODAL -->
<div class="modal" id="editModal">
  <div class="modal-box">
    <h3>Edit User</h3>
    <input type="hidden" id="editUserId" />
    <label>Username</label>
    <input type="text" id="editUsername" placeholder="Username" />
    <label>Email</label>
    <input type="email" id="editEmail" placeholder="Email" />
    <div class="modal-error" id="editError"></div>
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
      <button class="btn-save" onclick="saveUser()">Save</button>
    </div>
  </div>
</div>

<script>
  const API = '/api';
  let token = localStorage.getItem('admin_token');
  let adminUsername = localStorage.getItem('admin_username');

  // Check if already logged in
  if (token && adminUsername) {
    showApp();
  }

  async function doLogin() {
    const username = document.getElementById('loginUser').value;
    const password = document.getElementById('loginPass').value;
    const errEl = document.getElementById('loginError');

    try {
      const res = await fetch(`${API}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      // Check admin access
      const meRes = await fetch(`${API}/admin/stats`, {
        headers: { Authorization: `Bearer ${data.token}` }
      });
      if (!meRes.ok) throw new Error('You are not an admin');

      token = data.token;
      adminUsername = data.user.username;
      localStorage.setItem('admin_token', token);
      localStorage.setItem('admin_username', adminUsername);
      errEl.textContent = '';
      showApp();
    } catch (e) {
      errEl.textContent = e.message;
    }
  }

  function doLogout() {
    localStorage.removeItem('admin_token');
    localStorage.removeItem('admin_username');
    token = null;
    document.getElementById('app').style.display = 'none';
    document.getElementById('loginWrap').style.display = 'flex';
  }

  function showApp() {
    document.getElementById('loginWrap').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('adminName').textContent = adminUsername;
    loadStats();
  }

  function headers() {
    return { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` };
  }

  function showSection(name) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
    document.getElementById('sec-' + name).classList.add('active');
    event.target.classList.add('active');

    if (name === 'users')   loadUsers();
    if (name === 'results') loadResults();
    if (name === 'dashboard') loadStats();
  }

  async function loadStats() {
    const res = await fetch(`${API}/admin/stats`, { headers: headers() });
    const d = await res.json();
    document.getElementById('st-users').textContent = d.users;
    document.getElementById('st-games').textContent = d.games;
    document.getElementById('st-top').textContent   = d.topScore;
    document.getElementById('st-today').textContent = d.todayGames;
  }

  async function loadUsers() {
    const res = await fetch(`${API}/admin/users`, { headers: headers() });
    const d = await res.json();
    const tbody = document.getElementById('users-body');
    if (!d.users.length) { tbody.innerHTML = '<tr><td colspan="8" class="empty">No users</td></tr>'; return; }
    tbody.innerHTML = d.users.map(u => `
      <tr>
        <td>${u.id}</td>
        <td>${u.username}</td>
        <td>${u.email}</td>
        <td><span class="badge ${u.is_admin ? 'badge-admin' : 'badge-user'}">${u.is_admin ? 'Admin' : 'User'}</span></td>
        <td>${u.total_games || 0}</td>
        <td>${u.best_score || 0}</td>
        <td>${new Date(u.created_at).toLocaleDateString()}</td>
        <td>
          <button class="btn-edit" onclick="editUser(${u.id}, '${u.username}', '${u.email}')">Edit</button>
          <button class="btn-toggle" onclick="toggleAdmin(${u.id})">${u.is_admin ? 'Remove Admin' : 'Make Admin'}</button>
          <button class="btn-del" onclick="deleteUser(${u.id}, '${u.username}')">Delete</button>
        </td>
      </tr>
    `).join('');
  }

  async function loadResults() {
    const res = await fetch(`${API}/admin/results`, { headers: headers() });
    const d = await res.json();
    const tbody = document.getElementById('results-body');
    if (!d.results.length) { tbody.innerHTML = '<tr><td colspan="8" class="empty">No results</td></tr>'; return; }
    tbody.innerHTML = d.results.map(r => `
      <tr>
        <td>${r.id}</td>
        <td>${r.username}</td>
        <td>${r.score}</td>
        <td>${r.max_tile}</td>
        <td>${r.moves}</td>
        <td><span class="badge ${r.won ? 'badge-won' : 'badge-lost'}">${r.won ? 'Won' : 'Lost'}</span></td>
        <td>${new Date(r.played_at).toLocaleString()}</td>
        <td><button class="btn-del" onclick="deleteResult(${r.id})">Delete</button></td>
      </tr>
    `).join('');
  }

  async function deleteUser(id, username) {
    if (!confirm(`Delete user "${username}" and all their results?`)) return;
    await fetch(`${API}/admin/users/${id}`, { method: 'DELETE', headers: headers() });
    loadUsers();
    loadStats();
  }

  async function deleteResult(id) {
    if (!confirm('Delete this result?')) return;
    await fetch(`${API}/admin/results/${id}`, { method: 'DELETE', headers: headers() });
    loadResults();
    loadStats();
  }

  async function toggleAdmin(id) {
    await fetch(`${API}/admin/users/${id}/toggle-admin`, { method: 'PATCH', headers: headers() });
    loadUsers();
  }

  // Edit user modal
  function editUser(id, username, email) {
    document.getElementById('editUserId').value = id;
    document.getElementById('editUsername').value = username;
    document.getElementById('editEmail').value = email;
    document.getElementById('editError').textContent = '';
    document.getElementById('editModal').classList.add('show');
  }

  function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
  }

  async function saveUser() {
    const id = document.getElementById('editUserId').value;
    const username = document.getElementById('editUsername').value;
    const email = document.getElementById('editEmail').value;
    const errEl = document.getElementById('editError');

    if (!username || !email) {
      errEl.textContent = 'Username and email are required';
      return;
    }

    try {
      const res = await fetch(`${API}/admin/users/${id}`, {
        method: 'PUT',
        headers: headers(),
        body: JSON.stringify({ username, email })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      closeEditModal();
      loadUsers();
    } catch (e) {
      errEl.textContent = e.message;
    }
  }

  // Close modal on Escape
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeEditModal();
  });

  // Login on Enter key
  document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && document.getElementById('loginWrap').style.display !== 'none') doLogin();
  });
</script>
</body>
</html>
